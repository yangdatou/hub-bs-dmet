#INFO: **** input file is /Users/yangjunjie/work/hub-bs-dmet/fitting.py ****
import os, sys, typing
from typing import List, Tuple, Callable
sys.path.append(".")

from functools import reduce

import numpy, scipy
from scipy import linalg
from scipy.optimize import basinhopping

import jax
import jax.numpy as jnumpy
from jax.scipy.linalg import eigh
from jax.scipy.optimize import minimize

from pyscf import lib

class LossFunctionMixin(lib.StreamObject):
    spin   = None

    def __init__(self, h1e: numpy.ndarray, rdm1_tag: numpy.ndarray, fit_inds: numpy.ndarray,
                 nelecs: Tuple[int, int], loss_func_type: int = 1, stdout: typing.TextIO = sys.stdout):
        self.stdout = stdout

        spin = self.spin
        assert spin is not None

        # Convert fit_inds to a JAX array and extract dimensions
        fit_inds = jnumpy.asarray(fit_inds)
        nfrag    = fit_inds.shape[0]
        nimp     = fit_inds.shape[1]
        nsite    = nimp * nfrag

        ind_triu = jnumpy.triu_indices(nimp)
        num_triu = ind_triu[0].shape[0]
        num_parm = num_triu * spin
        
        # Ensure that dimensions of f1e and rdm1_tag match expected dimensions
        assert h1e.shape      == (nsite, nsite)
        assert rdm1_tag.shape == (nsite, nsite)

        self.h1e = h1e
        self.rdm1_tag = rdm1_tag
        self.fit_inds = fit_inds
        self.nelecs = nelecs
        self.loss_func_type = loss_func_type

        self.ind_triu = ind_triu
        self.num_triu = num_triu
        self.num_parm = num_parm

        self.nfrag    = nfrag
        self.nimp     = nimp
        self.nsite    = nsite

        h1es = jnumpy.zeros((spin, nsite, nsite))
        h1es = h1es.at[0].set(h1e)
        h1es = h1es.at[-1].set(h1e)
        self.h1es = h1es

        get_v1es = self._gen_get_v1es()
        get_rdm1 = self._gen_get_rdm1()

        # Helper functions
        self._get_v1es = self._gen_get_v1es()
        self._get_rdm1 = self._gen_get_rdm1()
        
        # If the number of fragments is 1, then all the
        # types of loss functions are equivalent.
        assert loss_func_type == 1 or nfrag != 1

        if loss_func_type == 1:
            def func(xs):
                # Fill the correlation potential and calculate f1e
                v1es_fit = get_v1es(xs)
                f1es_fit = h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit = get_rdm1(f1es_fit)[0]
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = rdm1_tag - rdm1_fit
                
                # The loss function is the norm of the RDM difference
                err = jnumpy.linalg.norm(rdm1_err)
                return err

        elif loss_func_type == 2:
            def func(xs):
                # Fill the correlation potential and calculate f1e
                v1es_fit = get_v1es(xs)
                f1es_fit = h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit = get_rdm1(f1es_fit)[0]
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = rdm1_tag - rdm1_fit

                # The loss function is the sum of the norms of the RDM differences for each fragment
                err = sum([jnumpy.linalg.norm(rdm1_err[fit_ind][:, fit_ind]) for fit_ind in fit_inds])
                return err

        elif loss_func_type == 3:
            def func(xs):
                # Fill the correlation potential and calculate f1e
                v1es_fit = get_v1es(xs)
                f1es_fit = h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit = get_rdm1(f1es_fit)[0]
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = rdm1_tag - rdm1_fit

                # The loss function is the sum of the norms of the RDM differences for each fragment
                err  = jnumpy.linalg.norm(rdm1_err)
                err += sum([jnumpy.linalg.norm(rdm1_err[fit_ind][:, fit_ind]) for fit_ind in fit_inds])
                return err

        else:
            raise ValueError("Invalid loss function type.")

        self.func = (lambda x: numpy.array(func(x)))
        self.grad = (lambda x: numpy.array(jax.grad(func)(x)))
        self.hess = (lambda x: numpy.array(jax.hessian(func)(x)))
        self._dump_info()

    def _dump_info(self):
        info = self.__dict__
        class_name = " " + self.__class__.__name__ + " "
        self.stdout.write("\n\n" + "#" * 20 + class_name + "#" * 20 + "\n")
        self.stdout.write("Loss Function Info:\n")
        
        for k, v in info.items():
            self.stdout.write(f"{k} = {v}\n")

        self.stdout.write("#" * (40 +  len(class_name)) + "\n")

    def _gen_get_v1es(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_v1es(xs):
            assert xs.shape == (spin * num_triu,)
            v1es = jnumpy.zeros((spin, nsite, nsite))

            for s, x in enumerate(jnumpy.split(xs, spin)):
                for fit_ind in fit_inds:
                    ind_0 = fit_ind[ind_triu[0]]
                    ind_1 = fit_ind[ind_triu[1]]
                    v1es  = v1es.at[s, ind_0, ind_1].set(x)

                v1e_sym = v1es[s] + jnumpy.transpose(v1es[s]) - jnumpy.diag(jnumpy.diag(v1es[s]))
                v1es    = v1es.at[s].set(v1e_sym)
            
            return v1es

        return get_v1es

    def _gen_get_rdm1(self, is_debug = False):
        raise NotImplementedError

class RestrictedSpinLossFunction(LossFunctionMixin):
    spin = 1
    def _gen_get_rdm1(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        nelec_alpha, nelec_beta = self.nelecs

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_rdm1(f1es):
            assert f1es.shape  == (spin, nsite, nsite)
            assert nelec_alpha == nelec_beta

            f1e = f1es[0]
            mo_ene_alph, mo_coeff_alph = eigh(f1e)
            mo_ene_beta, mo_coeff_beta = mo_ene_alph, mo_coeff_alph

            occ_idx_alph = jnumpy.argsort(mo_ene_alph)[:self.nelecs[0]]
            occ_idx_beta = jnumpy.argsort(mo_ene_beta)[:self.nelecs[1]]

            coeff_occ_alph = mo_coeff_alph[:, occ_idx_alph]
            coeff_occ_beta = mo_coeff_beta[:, occ_idx_beta]

            rdm1_fit_alph  = jnumpy.dot(coeff_occ_alph, coeff_occ_alph.T)
            rdm1_fit_beta  = jnumpy.dot(coeff_occ_beta, coeff_occ_beta.T)

            gdm1 = jnumpy.zeros((2 * nsite, 2 * nsite))
            gdm1 = gdm1.at[:nsite, :nsite].set(rdm1_fit_alph)
            gdm1 = gdm1.at[nsite:, nsite:].set(rdm1_fit_beta)

            return rdm1_fit_alph + rdm1_fit_beta, gdm1

        return get_rdm1

class UnrestrictedSpinLossFunction(LossFunctionMixin):
    spin = 2
    def _gen_get_rdm1(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        nelec_alpha, nelec_beta = self.nelecs

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_rdm1(f1es):
            assert f1es.shape  == (spin, nsite, nsite)
            assert nelec_alpha == nelec_beta

            f1e_alph, f1e_beta = f1es
            mo_ene_alph, mo_coeff_alph = eigh(f1e_alph)
            mo_ene_beta, mo_coeff_beta = eigh(f1e_beta)

            occ_idx_alph = jnumpy.argsort(mo_ene_alph)[:self.nelecs[0]]
            occ_idx_beta = jnumpy.argsort(mo_ene_beta)[:self.nelecs[1]]

            coeff_occ_alph = mo_coeff_alph[:, occ_idx_alph]
            coeff_occ_beta = mo_coeff_beta[:, occ_idx_beta]

            rdm1_fit_alph  = jnumpy.dot(coeff_occ_alph, coeff_occ_alph.T)
            rdm1_fit_beta  = jnumpy.dot(coeff_occ_beta, coeff_occ_beta.T)

            gdm1_fit = jnumpy.block([[rdm1_fit_alph, jnumpy.zeros((nsite, nsite))], [jnumpy.zeros((nsite, nsite)), rdm1_fit_beta]])

            return rdm1_fit_alph + rdm1_fit_beta, gdm1_fit

        return get_rdm1

class GeneralizedSpinLossFunction(LossFunctionMixin):
    spin = 4
    def _gen_get_rdm1(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        nelec_alpha, nelec_beta = self.nelecs

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_rdm1(f1es):
            assert f1es.shape  == (spin, nsite, nsite)
            assert nelec_alpha == nelec_beta

            f1e_aa, f1e_ab, f1e_ba, f1e_bb = f1es
            f1e_g = jnumpy.block([[f1e_aa, f1e_ab], [f1e_ba, f1e_bb]])

            mo_ene_g, mo_coeff_g = eigh(f1e_g)
            occ_idx_g = jnumpy.argsort(mo_ene_g)[:(nelec_alpha + nelec_beta)]

            coeff_occ_g = mo_coeff_g[:, occ_idx_g]
            gdm1_fit = jnumpy.dot(coeff_occ_g, coeff_occ_g.T)

            rdm1_fit_alph = gdm1_fit[:nsite, :nsite]
            rdm1_fit_beta = gdm1_fit[nsite:, nsite:]

            return rdm1_fit_alph + rdm1_fit_beta, gdm1_fit

        return get_rdm1

RLF = RestrictedSpinLossFunction
ULF = UnrestrictedSpinLossFunction
GLF = GeneralizedSpinLossFunction

from utils import print_matrix
from utils import RestrictedElectronicStructureProblem

from utils import solve_restricted_hartree_fock
from utils import solve_unrestricted_hartree_fock
from utils import solve_direct_spin1_full_configuration_interaction

from hub import build_hub_model
hub_u = 8.0
nsite  = 6
is_debug = True

for nelecs in [(2, 2), (3, 3), (4, 4)]:
    if is_debug and (not nelecs == (3, 3)):
        continue

    log = open(f"./log/hub-u-{hub_u:6.4f}-nelec-{nelecs[0]+nelecs[1]}" + ".log", "w")

    hub_obj         = build_hub_model(nsite, nelecs, hub_u)
    hub_obj.verbose = 4
    hub_obj.stdout  = log
    dm0_alph, dm0_beta = (lambda xs: (numpy.diag(xs[0]), numpy.diag(xs[1][::-1])))(numpy.asarray([[1, 0] for _ in range(nsite)]).reshape(2, -1))

    res_rhf = solve_restricted_hartree_fock(hub_obj,   dm0=dm0_alph+dm0_beta)
    res_uhf = solve_unrestricted_hartree_fock(hub_obj, dm0=(dm0_alph, dm0_beta))
    res_fci = solve_direct_spin1_full_configuration_interaction(hub_obj)

    ene_rhf = res_rhf.get_ene()
    ene_uhf = res_uhf.get_ene()
    ene_fci = res_fci.get_ene()

    r_rdm1_rhf = res_rhf.get_r_rdm1()
    r_rdm1_uhf = res_uhf.get_r_rdm1()
    r_rdm1_fci = res_fci.get_r_rdm1()
    rdm1_tag   = r_rdm1_fci

    for res in [res_rhf, res_uhf, res_fci]:
        ene    = res.get_ene()
        r_rdm1 = res.get_r_rdm1()
        u_rdm1 = res.get_u_rdm1()

        dm_err = numpy.abs(r_rdm1_fci - r_rdm1) 
        err_max = numpy.max(dm_err)
        err_avg = numpy.linalg.norm(dm_err) / numpy.size(dm_err)

        print(f"\n\n{res.__class__.__name__}", file=log)
        print(f"Energy: {ene:6.4f}, Error Max: {err_max:6.4e}, Avg: {err_avg:6.4e}", file=log)
        print_matrix(r_rdm1,    t="r_rdm1 = ", stdout=log)
        print_matrix(u_rdm1[0], t="u_rdm1_alph = ", stdout=log)
        print_matrix(u_rdm1[1], t="u_rdm1_beta = ", stdout=log)

    for igen_loss, LF in enumerate([RLF, ULF, GLF]):
        for (nimp, loss_func_type) in [(2, 1), (2, 2), (2, 3), (nsite, 1)]:
            if is_debug and (not (nimp == 2 and loss_func_type == 2)):
                continue
            
            fit_inds = numpy.asarray([[i+ifrag*nimp for i in range(nimp)] for ifrag in range(nsite // nimp)])
            kwargs   = {"stdout": log, "fit_inds": fit_inds, "nelecs": nelecs, "loss_func_type": loss_func_type}

            lf       = LF(hub_obj.h1, rdm1_tag, **kwargs)
            print("\n\n" + "#"*20, file=log)
            print(f"{lf.__class__.__name__}", file=log)
            print(f"nimp = {nimp}, nsite = {nsite}", file=log)
            print(f"nelecs = {nelecs}", file=log)
            print(f"loss_func_type = {loss_func_type}", file=log)

            x0 = numpy.zeros(lf.num_parm)

            global count, ymin
            count = 0
            ymin  = None

            def callback(x, y, accepted):
                # Fill the correlation potential and calculate f1e
                v1es_fit = lf._get_v1es(x)
                f1es_fit = lf.h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit, gdm1_fit = lf._get_rdm1(f1es_fit)
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = jnumpy.abs(rdm1_tag - rdm1_fit)

                err_mean = jnumpy.linalg.norm(rdm1_err) / numpy.size(rdm1_err)
                err_max  = jnumpy.max(rdm1_err)

                global count, ymin
                ymin = y if ymin is None else min(ymin, y)
                
                if is_debug:
                    print(f"count = {count:4d}, y = {y:6.4e}, ymin = {ymin:6.4e}, " + f"x = [" + " ".join([f"{xi:6.4f}" for xi in x]) + "]")
                    for (s, f1e) in enumerate(f1es_fit):
                        print_matrix(v1es_fit[s], t=f"v1es_fit[{s}] = ")
                        print_matrix(f1e, t=f"f1e[{s}] = ")

                    print_matrix(gdm1_fit, t="gdm1_fit = ")
                    print_matrix(rdm1_fit, t="rdm1_fit = ")
                    print_matrix(rdm1_err, t="rdm1_err = ")

                print(f"count = {count:4d}, y = {y:6.4e}, ymin = {ymin:6.4e}, " + f"x = [" + " ".join([f"{xi:6.4f}" for xi in x])+"]", file=log)
                count += 1

            kwargs = {
                "method": "bfgs", 
                "jac": lf.grad, 
                "tol": 1e-4, 
                "options": {"disp": False, "maxiter": 200}
                }

            res = basinhopping(
                lf.func, x0, niter=200, T=0.1, stepsize=0.6, disp=False,
                callback=callback, minimizer_kwargs=kwargs, 
                niter_success=10, interval=10, 
                )

            x = res.x
            # f1e_fit  = f._f1e + f._fill_correlation_potential(x)
            # rdm1_fit = (lambda rdm1: rdm1[0] + rdm1[1])(f._get_rdm1(f1e_fit))
            # rdm1_err = jnumpy.abs(rdm1_tag - rdm1_fit)
            # err_mean = jnumpy.linalg.norm(rdm1_err) / numpy.size(rdm1_err)
            # err_max  = jnumpy.max(rdm1_err)

            # print(f"\nLoss Function = {res.fun:6.4e}, Error Mean: {err_mean:6.4e}, Max: {err_max:6.4e}, Count: {count}", file=log)
            # print(f"Success = {res.lowest_optimization_result.success}", file=log)
            # print(f"Message = {res.lowest_optimization_result.message}", file=log)
            # print(f"x = " + " ".join([f"{xi:6.4f}" for xi in x]), file=log)
            
            # print(res, file=log)

            # print_matrix(rdm1_fit,   t="rdm1_fit = ", stdout=log)
            # print_matrix(rdm1_tag,   t="rdm1_tag = ", stdout=log)
            # print("\n\n" + "#"*20, file=log)#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Junjies-MacBook-Air.local', release='22.5.0', version='Darwin Kernel Version 22.5.0: Thu Jun  8 22:21:34 PDT 2023; root:xnu-8796.121.3~7/RELEASE_ARM64_T8112', machine='arm64')  Threads 1
Python 3.11.3 | packaged by conda-forge | (main, Apr  6 2023, 08:58:31) [Clang 14.0.6 ]
numpy 1.24.3  scipy 1.10.1
Date: Fri Jul 21 15:49:40 2023
PySCF version 2.2.1
PySCF path  /Users/yangjunjie/packages/pyscf/pyscf-2.2.1/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 0
[INPUT] num. electrons = 6
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom

nuclear repulsion = 0
number of shells = 0
number of NR pGTOs = 0
number of NR cGTOs = 0
basis = sto-3g
ecp = {}
CPU time:         0.41


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-06
SCF conv_tol_grad = None
SCF max_cycles = 200
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /var/folders/14/127wb84x5yx1jh4dxrvgcfkm0000gn/T/tmplmisdsg_
max_memory 4000 MB (current use 0 MB)
Overwritten attributes  get_ovlp get_hcore  of <class 'pyscf.scf.hf.RHF'>
Set gradient conv threshold to 0.001
init E= 12
  HOMO = 3  LUMO = 5
cycle= 1 E= 3.99999999999999  delta_E=   -8  |g|= 7.41e-15  |ddm|= 2.45
  HOMO = 3  LUMO = 5
cycle= 2 E= 4.00000000000001  delta_E= 2.13e-14  |g|= 1.29e-14  |ddm|= 5.62e-15
  HOMO = 3  LUMO = 5
Extra cycle  E= 4  delta_E= -1.42e-14  |g|= 4.32e-14  |ddm|= 8.98e-15
converged SCF energy = 4
#INFO: **** input file is /Users/yangjunjie/work/hub-bs-dmet/fitting.py ****
import os, sys, typing
from typing import List, Tuple, Callable
sys.path.append(".")

from functools import reduce

import numpy, scipy
from scipy import linalg
from scipy.optimize import basinhopping

import jax
import jax.numpy as jnumpy
from jax.scipy.linalg import eigh
from jax.scipy.optimize import minimize

from pyscf import lib

class LossFunctionMixin(lib.StreamObject):
    spin   = None

    def __init__(self, h1e: numpy.ndarray, rdm1_tag: numpy.ndarray, fit_inds: numpy.ndarray,
                 nelecs: Tuple[int, int], loss_func_type: int = 1, stdout: typing.TextIO = sys.stdout):
        self.stdout = stdout

        spin = self.spin
        assert spin is not None

        # Convert fit_inds to a JAX array and extract dimensions
        fit_inds = jnumpy.asarray(fit_inds)
        nfrag    = fit_inds.shape[0]
        nimp     = fit_inds.shape[1]
        nsite    = nimp * nfrag

        ind_triu = jnumpy.triu_indices(nimp)
        num_triu = ind_triu[0].shape[0]
        num_parm = num_triu * spin
        
        # Ensure that dimensions of f1e and rdm1_tag match expected dimensions
        assert h1e.shape      == (nsite, nsite)
        assert rdm1_tag.shape == (nsite, nsite)

        self.h1e = h1e
        self.rdm1_tag = rdm1_tag
        self.fit_inds = fit_inds
        self.nelecs = nelecs
        self.loss_func_type = loss_func_type

        self.ind_triu = ind_triu
        self.num_triu = num_triu
        self.num_parm = num_parm

        self.nfrag    = nfrag
        self.nimp     = nimp
        self.nsite    = nsite

        h1es = jnumpy.zeros((spin, nsite, nsite))
        h1es = h1es.at[0].set(h1e)
        h1es = h1es.at[-1].set(h1e)
        self.h1es = h1es

        get_v1es = self._gen_get_v1es()
        get_rdm1 = self._gen_get_rdm1()

        # Helper functions
        self._get_v1es = self._gen_get_v1es()
        self._get_rdm1 = self._gen_get_rdm1()
        
        # If the number of fragments is 1, then all the
        # types of loss functions are equivalent.
        assert loss_func_type == 1 or nfrag != 1

        if loss_func_type == 1:
            def func(xs):
                # Fill the correlation potential and calculate f1e
                v1es_fit = get_v1es(xs)
                f1es_fit = h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit = get_rdm1(f1es_fit)[0]
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = rdm1_tag - rdm1_fit
                
                # The loss function is the norm of the RDM difference
                err = jnumpy.linalg.norm(rdm1_err)
                return err

        elif loss_func_type == 2:
            def func(xs):
                # Fill the correlation potential and calculate f1e
                v1es_fit = get_v1es(xs)
                f1es_fit = h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit = get_rdm1(f1es_fit)[0]
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = rdm1_tag - rdm1_fit

                # The loss function is the sum of the norms of the RDM differences for each fragment
                err = sum([jnumpy.linalg.norm(rdm1_err[fit_ind][:, fit_ind]) for fit_ind in fit_inds])
                return err

        elif loss_func_type == 3:
            def func(xs):
                # Fill the correlation potential and calculate f1e
                v1es_fit = get_v1es(xs)
                f1es_fit = h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit = get_rdm1(f1es_fit)[0]
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = rdm1_tag - rdm1_fit

                # The loss function is the sum of the norms of the RDM differences for each fragment
                err  = jnumpy.linalg.norm(rdm1_err)
                err += sum([jnumpy.linalg.norm(rdm1_err[fit_ind][:, fit_ind]) for fit_ind in fit_inds])
                return err

        else:
            raise ValueError("Invalid loss function type.")

        self.func = (lambda x: numpy.array(func(x)))
        self.grad = (lambda x: numpy.array(jax.grad(func)(x)))
        self.hess = (lambda x: numpy.array(jax.hessian(func)(x)))
        self._dump_info()

    def _dump_info(self):
        info = self.__dict__
        class_name = " " + self.__class__.__name__ + " "
        self.stdout.write("\n\n" + "#" * 20 + class_name + "#" * 20 + "\n")
        self.stdout.write("Loss Function Info:\n")
        
        for k, v in info.items():
            self.stdout.write(f"{k} = {v}\n")

        self.stdout.write("#" * (40 +  len(class_name)) + "\n")

    def _gen_get_v1es(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_v1es(xs):
            assert xs.shape == (spin * num_triu,)
            v1es = jnumpy.zeros((spin, nsite, nsite))

            for s, x in enumerate(jnumpy.split(xs, spin)):
                for fit_ind in fit_inds:
                    ind_0 = fit_ind[ind_triu[0]]
                    ind_1 = fit_ind[ind_triu[1]]
                    v1es  = v1es.at[s, ind_0, ind_1].set(x)

                v1e_sym = v1es[s] + jnumpy.transpose(v1es[s]) - jnumpy.diag(jnumpy.diag(v1es[s]))
                v1es    = v1es.at[s].set(v1e_sym)
            
            return v1es

        return get_v1es

    def _gen_get_rdm1(self, is_debug = False):
        raise NotImplementedError

class RestrictedSpinLossFunction(LossFunctionMixin):
    spin = 1
    def _gen_get_rdm1(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        nelec_alpha, nelec_beta = self.nelecs

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_rdm1(f1es):
            assert f1es.shape  == (spin, nsite, nsite)
            assert nelec_alpha == nelec_beta

            f1e = f1es[0]
            mo_ene_alph, mo_coeff_alph = eigh(f1e)
            mo_ene_beta, mo_coeff_beta = mo_ene_alph, mo_coeff_alph

            occ_idx_alph = jnumpy.argsort(mo_ene_alph)[:self.nelecs[0]]
            occ_idx_beta = jnumpy.argsort(mo_ene_beta)[:self.nelecs[1]]

            coeff_occ_alph = mo_coeff_alph[:, occ_idx_alph]
            coeff_occ_beta = mo_coeff_beta[:, occ_idx_beta]

            rdm1_fit_alph  = jnumpy.dot(coeff_occ_alph, coeff_occ_alph.T)
            rdm1_fit_beta  = jnumpy.dot(coeff_occ_beta, coeff_occ_beta.T)

            gdm1 = jnumpy.zeros((2 * nsite, 2 * nsite))
            gdm1 = gdm1.at[:nsite, :nsite].set(rdm1_fit_alph)
            gdm1 = gdm1.at[nsite:, nsite:].set(rdm1_fit_beta)

            return rdm1_fit_alph + rdm1_fit_beta, gdm1

        return get_rdm1

class UnrestrictedSpinLossFunction(LossFunctionMixin):
    spin = 2
    def _gen_get_rdm1(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        nelec_alpha, nelec_beta = self.nelecs

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_rdm1(f1es):
            assert f1es.shape  == (spin, nsite, nsite)
            assert nelec_alpha == nelec_beta

            f1e_alph, f1e_beta = f1es
            mo_ene_alph, mo_coeff_alph = eigh(f1e_alph)
            mo_ene_beta, mo_coeff_beta = eigh(f1e_beta)

            occ_idx_alph = jnumpy.argsort(mo_ene_alph)[:self.nelecs[0]]
            occ_idx_beta = jnumpy.argsort(mo_ene_beta)[:self.nelecs[1]]

            coeff_occ_alph = mo_coeff_alph[:, occ_idx_alph]
            coeff_occ_beta = mo_coeff_beta[:, occ_idx_beta]

            rdm1_fit_alph  = jnumpy.dot(coeff_occ_alph, coeff_occ_alph.T)
            rdm1_fit_beta  = jnumpy.dot(coeff_occ_beta, coeff_occ_beta.T)

            gdm1_fit = jnumpy.block([[rdm1_fit_alph, jnumpy.zeros((nsite, nsite))], [jnumpy.zeros((nsite, nsite)), rdm1_fit_beta]])

            return rdm1_fit_alph + rdm1_fit_beta, gdm1_fit

        return get_rdm1

class GeneralizedSpinLossFunction(LossFunctionMixin):
    spin = 4
    def _gen_get_rdm1(self):
        spin     = self.spin
        nsite    = self.nsite
        nimp     = self.nimp
        nfrag    = self.nfrag

        nelec_alpha, nelec_beta = self.nelecs

        num_triu = self.num_triu
        ind_triu = self.ind_triu
        fit_inds = self.fit_inds

        def get_rdm1(f1es):
            assert f1es.shape  == (spin, nsite, nsite)
            assert nelec_alpha == nelec_beta

            f1e_aa, f1e_ab, f1e_ba, f1e_bb = f1es
            f1e_g = jnumpy.block([[f1e_aa, f1e_ab], [f1e_ba, f1e_bb]])

            mo_ene_g, mo_coeff_g = eigh(f1e_g)
            occ_idx_g = jnumpy.argsort(mo_ene_g)[:(nelec_alpha + nelec_beta)]

            coeff_occ_g = mo_coeff_g[:, occ_idx_g]
            gdm1_fit = jnumpy.dot(coeff_occ_g, coeff_occ_g.T)

            rdm1_fit_alph = gdm1_fit[:nsite, :nsite]
            rdm1_fit_beta = gdm1_fit[nsite:, nsite:]

            return rdm1_fit_alph + rdm1_fit_beta, gdm1_fit

        return get_rdm1

RLF = RestrictedSpinLossFunction
ULF = UnrestrictedSpinLossFunction
GLF = GeneralizedSpinLossFunction

from utils import print_matrix
from utils import RestrictedElectronicStructureProblem

from utils import solve_restricted_hartree_fock
from utils import solve_unrestricted_hartree_fock
from utils import solve_direct_spin1_full_configuration_interaction

from hub import build_hub_model
hub_u = 8.0
nsite  = 6
is_debug = True

for nelecs in [(2, 2), (3, 3), (4, 4)]:
    if is_debug and (not nelecs == (3, 3)):
        continue

    log = open(f"./log/hub-u-{hub_u:6.4f}-nelec-{nelecs[0]+nelecs[1]}" + ".log", "w")

    hub_obj         = build_hub_model(nsite, nelecs, hub_u)
    hub_obj.verbose = 4
    hub_obj.stdout  = log
    dm0_alph, dm0_beta = (lambda xs: (numpy.diag(xs[0]), numpy.diag(xs[1][::-1])))(numpy.asarray([[1, 0] for _ in range(nsite)]).reshape(2, -1))

    res_rhf = solve_restricted_hartree_fock(hub_obj,   dm0=dm0_alph+dm0_beta)
    res_uhf = solve_unrestricted_hartree_fock(hub_obj, dm0=(dm0_alph, dm0_beta))
    res_fci = solve_direct_spin1_full_configuration_interaction(hub_obj)

    ene_rhf = res_rhf.get_ene()
    ene_uhf = res_uhf.get_ene()
    ene_fci = res_fci.get_ene()

    r_rdm1_rhf = res_rhf.get_r_rdm1()
    r_rdm1_uhf = res_uhf.get_r_rdm1()
    r_rdm1_fci = res_fci.get_r_rdm1()
    rdm1_tag   = r_rdm1_fci

    for res in [res_rhf, res_uhf, res_fci]:
        ene    = res.get_ene()
        r_rdm1 = res.get_r_rdm1()
        u_rdm1 = res.get_u_rdm1()

        dm_err = numpy.abs(r_rdm1_fci - r_rdm1) 
        err_max = numpy.max(dm_err)
        err_avg = numpy.linalg.norm(dm_err) / numpy.size(dm_err)

        print(f"\n\n{res.__class__.__name__}", file=log)
        print(f"Energy: {ene:6.4f}, Error Max: {err_max:6.4e}, Avg: {err_avg:6.4e}", file=log)
        print_matrix(r_rdm1,    t="r_rdm1 = ", stdout=log)
        print_matrix(u_rdm1[0], t="u_rdm1_alph = ", stdout=log)
        print_matrix(u_rdm1[1], t="u_rdm1_beta = ", stdout=log)

    for igen_loss, LF in enumerate([RLF, ULF, GLF]):
        for (nimp, loss_func_type) in [(2, 1), (2, 2), (2, 3), (nsite, 1)]:
            if is_debug and (not (nimp == 2 and loss_func_type == 2)):
                continue
            
            fit_inds = numpy.asarray([[i+ifrag*nimp for i in range(nimp)] for ifrag in range(nsite // nimp)])
            kwargs   = {"stdout": log, "fit_inds": fit_inds, "nelecs": nelecs, "loss_func_type": loss_func_type}

            lf       = LF(hub_obj.h1, rdm1_tag, **kwargs)
            print("\n\n" + "#"*20, file=log)
            print(f"{lf.__class__.__name__}", file=log)
            print(f"nimp = {nimp}, nsite = {nsite}", file=log)
            print(f"nelecs = {nelecs}", file=log)
            print(f"loss_func_type = {loss_func_type}", file=log)

            x0 = numpy.zeros(lf.num_parm)

            global count, ymin
            count = 0
            ymin  = None

            def callback(x, y, accepted):
                # Fill the correlation potential and calculate f1e
                v1es_fit = lf._get_v1es(x)
                f1es_fit = lf.h1es + v1es_fit
                # Obtain the total RDM
                rdm1_fit, gdm1_fit = lf._get_rdm1(f1es_fit)
                # Calculate the difference between the target and fitted RDMs
                rdm1_err = jnumpy.abs(rdm1_tag - rdm1_fit)

                err_mean = jnumpy.linalg.norm(rdm1_err) / numpy.size(rdm1_err)
                err_max  = jnumpy.max(rdm1_err)

                global count, ymin
                ymin = y if ymin is None else min(ymin, y)
                
                if is_debug:
                    print(f"count = {count:4d}, y = {y:6.4e}, ymin = {ymin:6.4e}, " + f"x = [" + " ".join([f"{xi:6.4f}" for xi in x]) + "]")
                    for (s, f1e) in enumerate(f1es_fit):
                        print_matrix(v1es_fit[s], t=f"v1es_fit[{s}] = ")
                        print_matrix(f1e, t=f"f1e[{s}] = ")

                    print_matrix(gdm1_fit, t="gdm1_fit = ")
                    print_matrix(rdm1_fit, t="rdm1_fit = ")
                    print_matrix(rdm1_err, t="rdm1_err = ")

                print(f"count = {count:4d}, y = {y:6.4e}, ymin = {ymin:6.4e}, " + f"x = [" + " ".join([f"{xi:6.4f}" for xi in x])+"]", file=log)
                count += 1

            kwargs = {
                "method": "bfgs", 
                "jac": lf.grad, 
                "tol": 1e-4, 
                "options": {"disp": False, "maxiter": 200}
                }

            res = basinhopping(
                lf.func, x0, niter=200, T=0.1, stepsize=0.6, disp=False,
                callback=callback, minimizer_kwargs=kwargs, 
                niter_success=10, interval=10, 
                )

            x = res.x
            # f1e_fit  = f._f1e + f._fill_correlation_potential(x)
            # rdm1_fit = (lambda rdm1: rdm1[0] + rdm1[1])(f._get_rdm1(f1e_fit))
            # rdm1_err = jnumpy.abs(rdm1_tag - rdm1_fit)
            # err_mean = jnumpy.linalg.norm(rdm1_err) / numpy.size(rdm1_err)
            # err_max  = jnumpy.max(rdm1_err)

            # print(f"\nLoss Function = {res.fun:6.4e}, Error Mean: {err_mean:6.4e}, Max: {err_max:6.4e}, Count: {count}", file=log)
            # print(f"Success = {res.lowest_optimization_result.success}", file=log)
            # print(f"Message = {res.lowest_optimization_result.message}", file=log)
            # print(f"x = " + " ".join([f"{xi:6.4f}" for xi in x]), file=log)
            
            # print(res, file=log)

            # print_matrix(rdm1_fit,   t="rdm1_fit = ", stdout=log)
            # print_matrix(rdm1_tag,   t="rdm1_tag = ", stdout=log)
            # print("\n\n" + "#"*20, file=log)#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Junjies-MacBook-Air.local', release='22.5.0', version='Darwin Kernel Version 22.5.0: Thu Jun  8 22:21:34 PDT 2023; root:xnu-8796.121.3~7/RELEASE_ARM64_T8112', machine='arm64')  Threads 1
Python 3.11.3 | packaged by conda-forge | (main, Apr  6 2023, 08:58:31) [Clang 14.0.6 ]
numpy 1.24.3  scipy 1.10.1
Date: Fri Jul 21 15:49:40 2023
PySCF version 2.2.1
PySCF path  /Users/yangjunjie/packages/pyscf/pyscf-2.2.1/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 0
[INPUT] num. electrons = 6
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom

nuclear repulsion = 0
number of shells = 0
number of NR pGTOs = 0
number of NR cGTOs = 0
basis = sto-3g
ecp = {}
CPU time:         0.42


******** <class 'pyscf.scf.uhf.UHF'> ********
method = UHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
SCF conv_tol = 1e-06
SCF conv_tol_grad = None
SCF max_cycles = 200
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /var/folders/14/127wb84x5yx1jh4dxrvgcfkm0000gn/T/tmpdyek3h2w
max_memory 4000 MB (current use 0 MB)
number electrons alpha = 3  beta = 3
Overwritten attributes  get_ovlp get_hcore  of <class 'pyscf.scf.uhf.UHF'>
Set gradient conv threshold to 0.001
init E= 0
  alpha nocc = 3  HOMO = -0.123105625617661  LUMO = 8.12310562561766
  beta  nocc = 3  HOMO = -0.123105625617661  LUMO = 8.12310562561766
cycle= 1 E= -1.47312115874708  delta_E= -1.47  |g|= 0.176  |ddm|= 0.575
  alpha nocc = 3  HOMO = 0.0903326183076389  LUMO = 7.90966738169236
  beta  nocc = 3  HOMO = 0.0903326183076365  LUMO = 7.90966738169237
cycle= 2 E= -1.47725639450065  delta_E= -0.00414  |g|= 0.0194  |ddm|= 0.0301
  alpha nocc = 3  HOMO = 0.115471455540606  LUMO = 7.88452854445939
  beta  nocc = 3  HOMO = 0.115471455540607  LUMO = 7.88452854445939
cycle= 3 E= -1.47730782420845  delta_E= -5.14e-05  |g|= 7.98e-05  |ddm|= 0.00375
  alpha nocc = 3  HOMO = 0.115575007304049  LUMO = 7.88442499269594
  beta  nocc = 3  HOMO = 0.11557500730405  LUMO = 7.88442499269595
cycle= 4 E= -1.47730782508382  delta_E= -8.75e-10  |g|= 3.74e-10  |ddm|= 1.55e-05
  alpha nocc = 3  HOMO = 0.115575006874255  LUMO = 7.88442499312574
  beta  nocc = 3  HOMO = 0.115575006874255  LUMO = 7.88442499312574
Extra cycle  E= -1.47730782508382  delta_E= -8.88e-16  |g|= 4.3e-11  |ddm|= 6.45e-11
converged SCF energy = -1.47730782508382  <S^2> = 2.6463192  2S+1 = 3.4037151


RestrictedHartreeFock
Energy: 4.0000, Error Max: 3.3953e-01, Avg: 3.7519e-02

r_rdm1 = 
        #0        #1        #2        #3        #4       
0       1.00000   0.66667  -0.00000  -0.33333   0.00000
1       0.66667   1.00000   0.66667  -0.00000  -0.33333
2      -0.00000   0.66667   1.00000   0.66667   0.00000
3      -0.33333  -0.00000   0.66667   1.00000   0.66667
4       0.00000  -0.33333   0.00000   0.66667   1.00000
5       0.66667   0.00000  -0.33333  -0.00000   0.66667
        #5       
0       0.66667
1       0.00000
2      -0.33333
3      -0.00000
4       0.66667
5       1.00000

u_rdm1_alph = 
        #0        #1        #2        #3        #4       
0       0.50000   0.33333  -0.00000  -0.16667   0.00000
1       0.33333   0.50000   0.33333  -0.00000  -0.16667
2      -0.00000   0.33333   0.50000   0.33333   0.00000
3      -0.16667  -0.00000   0.33333   0.50000   0.33333
4       0.00000  -0.16667   0.00000   0.33333   0.50000
5       0.33333   0.00000  -0.16667  -0.00000   0.33333
        #5       
0       0.33333
1       0.00000
2      -0.16667
3      -0.00000
4       0.33333
5       0.50000

u_rdm1_beta = 
        #0        #1        #2        #3        #4       
0       0.50000   0.33333  -0.00000  -0.16667   0.00000
1       0.33333   0.50000   0.33333  -0.00000  -0.16667
2      -0.00000   0.33333   0.50000   0.33333   0.00000
3      -0.16667  -0.00000   0.33333   0.50000   0.33333
4       0.00000  -0.16667   0.00000   0.33333   0.50000
5       0.33333   0.00000  -0.16667  -0.00000   0.33333
        #5       
0       0.33333
1       0.00000
2      -0.16667
3      -0.00000
4       0.33333
5       0.50000


UnrestrictedHartreeFock
Energy: -1.4773, Error Max: 8.4575e-02, Avg: 8.7529e-03

r_rdm1 = 
        #0        #1        #2        #3        #4       
0       1.00000   0.24256   0.00000  -0.01488   0.00000
1       0.24256   1.00000   0.24256  -0.00000  -0.01488
2       0.00000   0.24256   1.00000   0.24256   0.00000
3      -0.01488  -0.00000   0.24256   1.00000   0.24256
4       0.00000  -0.01488   0.00000   0.24256   1.00000
5       0.24256  -0.00000  -0.01488  -0.00000   0.24256
        #5       
0       0.24256
1      -0.00000
2      -0.01488
3      -0.00000
4       0.24256
5       1.00000

u_rdm1_alph = 
        #0        #1        #2        #3        #4       
0       0.96919   0.12128  -0.01396  -0.00744  -0.01396
1       0.12128   0.03081   0.12128   0.01396  -0.00744
2      -0.01396   0.12128   0.96919   0.12128  -0.01396
3      -0.00744   0.01396   0.12128   0.03081   0.12128
4      -0.01396  -0.00744  -0.01396   0.12128   0.96919
5       0.12128   0.01396  -0.00744   0.01396   0.12128
        #5       
0       0.12128
1       0.01396
2      -0.00744
3       0.01396
4       0.12128
5       0.03081

u_rdm1_beta = 
        #0        #1        #2        #3        #4       
0       0.03081   0.12128   0.01396  -0.00744   0.01396
1       0.12128   0.96919   0.12128  -0.01396  -0.00744
2       0.01396   0.12128   0.03081   0.12128   0.01396
3      -0.00744  -0.01396   0.12128   0.96919   0.12128
4       0.01396  -0.00744   0.01396   0.12128   0.03081
5       0.12128  -0.01396  -0.00744  -0.01396   0.12128
        #5       
0       0.12128
1      -0.01396
2      -0.00744
3      -0.01396
4       0.12128
5       0.96919


DirectSpin1FullConfigurationInteraction
Energy: -2.0481, Error Max: 0.0000e+00, Avg: 0.0000e+00

r_rdm1 = 
        #0        #1        #2        #3        #4       
0       1.00000   0.32714  -0.00000  -0.06223  -0.00000
1       0.32714   1.00000   0.32714   0.00000  -0.06223
2      -0.00000   0.32714   1.00000   0.32714  -0.00000
3      -0.06223   0.00000   0.32714   1.00000   0.32714
4      -0.00000  -0.06223  -0.00000   0.32714   1.00000
5       0.32714   0.00000  -0.06223   0.00000   0.32714
        #5       
0       0.32714
1       0.00000
2      -0.06223
3       0.00000
4       0.32714
5       1.00000

u_rdm1_alph = 
        #0        #1        #2        #3        #4       
0       0.50000   0.16357  -0.00000  -0.03112  -0.00000
1       0.16357   0.50000   0.16357   0.00000  -0.03112
2      -0.00000   0.16357   0.50000   0.16357  -0.00000
3      -0.03112   0.00000   0.16357   0.50000   0.16357
4      -0.00000  -0.03112  -0.00000   0.16357   0.50000
5       0.16357   0.00000  -0.03112   0.00000   0.16357
        #5       
0       0.16357
1       0.00000
2      -0.03112
3       0.00000
4       0.16357
5       0.50000

u_rdm1_beta = 
        #0        #1        #2        #3        #4       
0       0.50000   0.16357  -0.00000  -0.03112   0.00000
1       0.16357   0.50000   0.16357  -0.00000  -0.03112
2      -0.00000   0.16357   0.50000   0.16357   0.00000
3      -0.03112  -0.00000   0.16357   0.50000   0.16357
4       0.00000  -0.03112   0.00000   0.16357   0.50000
5       0.16357  -0.00000  -0.03112   0.00000   0.16357
        #5       
0       0.16357
1      -0.00000
2      -0.03112
3       0.00000
4       0.16357
5       0.50000


#################### RestrictedSpinLossFunction ####################
Loss Function Info:
stdout = <_io.TextIOWrapper name='./log/hub-u-8.0000-nelec-6.log' mode='w' encoding='UTF-8'>
h1e = [[ 0. -1.  0.  0.  0. -1.]
 [-1.  0. -1.  0.  0.  0.]
 [ 0. -1.  0. -1.  0.  0.]
 [ 0.  0. -1.  0. -1.  0.]
 [ 0.  0.  0. -1.  0. -1.]
 [-1.  0.  0.  0. -1.  0.]]
rdm1_tag = [[ 1.00000000e+00  3.27136735e-01 -3.15549381e-17 -6.22326908e-02
  -1.38587046e-16  3.27136735e-01]
 [ 3.27136735e-01  1.00000000e+00  3.27136735e-01  4.33923795e-17
  -6.22326908e-02  1.71462084e-16]
 [-3.15549381e-17  3.27136735e-01  1.00000000e+00  3.27136735e-01
  -4.28437139e-17 -6.22326908e-02]
 [-6.22326908e-02  4.33923795e-17  3.27136735e-01  1.00000000e+00
   3.27136735e-01  2.82264070e-17]
 [-1.38587046e-16 -6.22326908e-02 -4.28437139e-17  3.27136735e-01
   1.00000000e+00  3.27136735e-01]
 [ 3.27136735e-01  1.71462084e-16 -6.22326908e-02  2.82264070e-17
   3.27136735e-01  1.00000000e+00]]
fit_inds = [[0 1]
 [2 3]
 [4 5]]
nelecs = (3, 3)
loss_func_type = 2
ind_triu = (Array([0, 0, 1], dtype=int32), Array([0, 1, 1], dtype=int32))
num_triu = 3
num_parm = 3
nfrag = 3
nimp = 2
nsite = 6
h1es = [[[ 0. -1.  0.  0.  0. -1.]
  [-1.  0. -1.  0.  0.  0.]
  [ 0. -1.  0. -1.  0.  0.]
  [ 0.  0. -1.  0. -1.  0.]
  [ 0.  0.  0. -1.  0. -1.]
  [-1.  0.  0.  0. -1.  0.]]]
_get_v1es = <function LossFunctionMixin._gen_get_v1es.<locals>.get_v1es at 0x116c0cc20>
_get_rdm1 = <function RestrictedSpinLossFunction._gen_get_rdm1.<locals>.get_rdm1 at 0x116c0d620>
func = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x116c0d4e0>
grad = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x116c0cfe0>
hess = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x116c0d580>
####################################################################


####################
RestrictedSpinLossFunction
nimp = 2, nsite = 6
nelecs = (3, 3)
loss_func_type = 2
count =    0, y = 1.4405e+00, ymin = 1.4405e+00, x = [0.0000 0.0000 0.0000]
count =    1, y = 1.6975e+00, ymin = 1.4405e+00, x = [-0.2620 0.1601 0.5333]
count =    2, y = 9.5636e-07, ymin = 9.5636e-07, x = [0.0964 0.5080 0.0964]
count =    3, y = 6.4448e-06, ymin = 9.5636e-07, x = [0.1328 0.5080 0.1328]
count =    4, y = 2.5461e-02, ymin = 9.5636e-07, x = [0.1959 0.5156 0.1986]
count =    5, y = 4.3100e-02, ymin = 9.5636e-07, x = [0.3067 0.5020 0.3249]
count =    6, y = 8.1133e-01, ymin = 9.5636e-07, x = [0.1838 0.6871 0.4562]
count =    7, y = 1.3580e+00, ymin = 9.5636e-07, x = [0.0985 0.6113 0.7504]
count =    8, y = 6.5118e-03, ymin = 9.5636e-07, x = [-0.2039 0.5079 -0.2070]
count =    9, y = 1.1462e+00, ymin = 9.5636e-07, x = [0.0618 0.2689 -0.3996]
count =   10, y = 8.7842e-07, ymin = 8.7842e-07, x = [-0.6584 0.5081 -0.6584]
count =   11, y = 4.0197e-02, ymin = 8.7842e-07, x = [-0.9035 0.5195 -0.9107]
count =   12, y = 8.0793e-07, ymin = 8.0793e-07, x = [-0.6088 0.5081 -0.6088]
count =   13, y = 2.9950e-06, ymin = 8.0793e-07, x = [-0.9702 0.5081 -0.9702]
count =   14, y = 9.8196e-07, ymin = 8.0793e-07, x = [-1.1321 0.5080 -1.1321]
count =   15, y = 1.4671e+00, ymin = 8.0793e-07, x = [-0.7677 1.0287 -0.8802]
count =   16, y = 1.2440e-06, ymin = 8.0793e-07, x = [-0.7526 0.5080 -0.7526]
count =   17, y = 6.2193e-07, ymin = 6.2193e-07, x = [-0.7552 0.5080 -0.7552]
count =   18, y = 3.2787e-03, ymin = 6.2193e-07, x = [-0.6414 0.5088 -0.6424]
count =   19, y = 1.0848e-02, ymin = 6.2193e-07, x = [-0.5925 0.5075 -0.5875]
count =   20, y = 1.5231e+00, ymin = 6.2193e-07, x = [-0.1803 -0.0363 -0.0805]
count =   21, y = 1.4260e-06, ymin = 6.2193e-07, x = [-0.5500 0.5081 -0.5500]
count =   22, y = 1.5922e+00, ymin = 6.2193e-07, x = [-0.4460 0.9636 -0.8846]
count =   23, y = 1.1688e-01, ymin = 6.2193e-07, x = [-0.2591 0.5309 -0.2166]
count =   24, y = 3.0936e-03, ymin = 6.2193e-07, x = [-0.2164 0.5074 -0.2174]
count =   25, y = 2.6245e-06, ymin = 6.2193e-07, x = [-0.7288 0.5080 -0.7288]
count =   26, y = 7.6497e-07, ymin = 6.2193e-07, x = [-0.6403 0.5080 -0.6403]
count =   27, y = 1.6090e-06, ymin = 6.2193e-07, x = [-0.6796 0.5080 -0.6796]
count =   28, y = 8.5225e-07, ymin = 6.2193e-07, x = [-0.8226 0.5081 -0.8226]


#################### UnrestrictedSpinLossFunction ####################
Loss Function Info:
stdout = <_io.TextIOWrapper name='./log/hub-u-8.0000-nelec-6.log' mode='w' encoding='UTF-8'>
h1e = [[ 0. -1.  0.  0.  0. -1.]
 [-1.  0. -1.  0.  0.  0.]
 [ 0. -1.  0. -1.  0.  0.]
 [ 0.  0. -1.  0. -1.  0.]
 [ 0.  0.  0. -1.  0. -1.]
 [-1.  0.  0.  0. -1.  0.]]
rdm1_tag = [[ 1.00000000e+00  3.27136735e-01 -3.15549381e-17 -6.22326908e-02
  -1.38587046e-16  3.27136735e-01]
 [ 3.27136735e-01  1.00000000e+00  3.27136735e-01  4.33923795e-17
  -6.22326908e-02  1.71462084e-16]
 [-3.15549381e-17  3.27136735e-01  1.00000000e+00  3.27136735e-01
  -4.28437139e-17 -6.22326908e-02]
 [-6.22326908e-02  4.33923795e-17  3.27136735e-01  1.00000000e+00
   3.27136735e-01  2.82264070e-17]
 [-1.38587046e-16 -6.22326908e-02 -4.28437139e-17  3.27136735e-01
   1.00000000e+00  3.27136735e-01]
 [ 3.27136735e-01  1.71462084e-16 -6.22326908e-02  2.82264070e-17
   3.27136735e-01  1.00000000e+00]]
fit_inds = [[0 1]
 [2 3]
 [4 5]]
nelecs = (3, 3)
loss_func_type = 2
ind_triu = (Array([0, 0, 1], dtype=int32), Array([0, 1, 1], dtype=int32))
num_triu = 3
num_parm = 6
nfrag = 3
nimp = 2
nsite = 6
h1es = [[[ 0. -1.  0.  0.  0. -1.]
  [-1.  0. -1.  0.  0.  0.]
  [ 0. -1.  0. -1.  0.  0.]
  [ 0.  0. -1.  0. -1.  0.]
  [ 0.  0.  0. -1.  0. -1.]
  [-1.  0.  0.  0. -1.  0.]]

 [[ 0. -1.  0.  0.  0. -1.]
  [-1.  0. -1.  0.  0.  0.]
  [ 0. -1.  0. -1.  0.  0.]
  [ 0.  0. -1.  0. -1.  0.]
  [ 0.  0.  0. -1.  0. -1.]
  [-1.  0.  0.  0. -1.  0.]]]
_get_v1es = <function LossFunctionMixin._gen_get_v1es.<locals>.get_v1es at 0x120a4f920>
_get_rdm1 = <function UnrestrictedSpinLossFunction._gen_get_rdm1.<locals>.get_rdm1 at 0x120a4e520>
func = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x120a4fec0>
grad = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x120a4f4c0>
hess = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x120a4eb60>
######################################################################


####################
UnrestrictedSpinLossFunction
nimp = 2, nsite = 6
nelecs = (3, 3)
loss_func_type = 2
count =    0, y = 1.4405e+00, ymin = 1.4405e+00, x = [0.0000 0.0000 0.0000 0.0000 0.0000 0.0000]
count =    1, y = 1.4011e+00, ymin = 1.4011e+00, x = [-0.4594 0.3207 0.4409 0.1445 -0.3103 -0.0381]
count =    2, y = 1.8982e-01, ymin = 1.8982e-01, x = [0.1713 1.2271 0.1802 0.4801 0.0027 0.3995]
count =    3, y = 5.5425e-01, ymin = 1.8982e-01, x = [-0.2021 0.7681 -0.3970 0.2414 0.3998 0.9637]
count =    4, y = 9.5376e-01, ymin = 1.8982e-01, x = [0.7181 1.2884 0.3109 0.0846 0.4801 0.7599]
count =    5, y = 1.2846e+00, ymin = 1.8982e-01, x = [0.7463 1.5004 -0.3543 -0.0109 0.4812 0.5312]
count =    6, y = 8.9327e-02, ymin = 8.9327e-02, x = [0.0749 1.2793 -0.0811 0.0938 -0.3386 0.2357]
count =    7, y = 2.7082e-01, ymin = 8.9327e-02, x = [0.2469 1.3170 0.1449 -0.1353 -0.5302 -0.3192]
count =    8, y = 1.0018e+00, ymin = 8.9327e-02, x = [-0.0278 1.4442 0.3372 -0.2664 -0.2210 0.4821]
count =    9, y = 5.0488e-01, ymin = 8.9327e-02, x = [-0.0860 1.4578 -0.2832 0.1207 -0.2830 -0.2265]
count =   10, y = 1.0273e+00, ymin = 8.9327e-02, x = [0.6061 1.2068 -0.5890 -0.0503 -0.6214 0.0875]
count =   11, y = 6.9191e-01, ymin = 8.9327e-02, x = [-0.0770 1.4798 -0.1128 0.3460 0.1930 -0.0155]
count =   12, y = 2.8083e-02, ymin = 2.8083e-02, x = [0.2254 1.5448 0.1032 0.0468 -0.5686 0.3092]
count =   13, y = 2.6880e-01, ymin = 2.8083e-02, x = [0.2732 1.5921 0.4293 0.4899 -0.8611 0.5567]
count =   14, y = 5.0131e-01, ymin = 2.8083e-02, x = [-0.1902 1.1718 -0.2900 -0.3819 -1.8926 0.3826]
count =   15, y = 2.0591e-01, ymin = 2.8083e-02, x = [-0.1882 1.3882 -0.0583 0.1803 -0.1456 0.1791]
count =   16, y = 8.4139e-01, ymin = 2.8083e-02, x = [-0.5730 1.4234 0.3845 0.1011 -0.0636 -0.1104]
count =   17, y = 4.6304e-03, ymin = 4.6304e-03, x = [-0.0191 1.5457 -0.2180 -0.1947 -0.5382 0.1972]
count =   18, y = 7.9969e-01, ymin = 4.6304e-03, x = [0.3930 1.8095 -0.7405 -0.1708 -0.9777 0.7035]
count =   19, y = 1.6982e-01, ymin = 4.6304e-03, x = [0.1856 1.1670 -0.4760 -0.8014 -0.5942 0.5174]
count =   20, y = 2.9610e-01, ymin = 4.6304e-03, x = [0.1954 1.5948 0.1561 -0.5159 -0.3763 -0.0478]
count =   21, y = 1.9436e-01, ymin = 4.6304e-03, x = [0.2686 1.2893 0.1128 -0.3086 -0.5941 0.1207]
count =   22, y = 7.1484e-02, ymin = 4.6304e-03, x = [0.4761 1.2140 -0.0870 -0.4175 -0.3719 0.5259]
count =   23, y = 2.9280e-04, ymin = 2.9280e-04, x = [0.2456 1.4761 0.1239 0.2262 -0.4381 0.4375]
count =   24, y = 1.1165e-02, ymin = 2.9280e-04, x = [0.1505 1.4908 0.3806 0.5638 -0.4841 0.1366]
count =   25, y = 1.5413e-01, ymin = 2.9280e-04, x = [0.0914 1.4352 0.3545 1.0926 -0.8851 0.4605]
count =   26, y = 1.7279e-06, ymin = 1.7279e-06, x = [-0.0846 1.7370 -0.0483 0.2442 -0.6642 0.1381]
count =   27, y = 1.1932e-01, ymin = 1.7279e-06, x = [-0.3020 1.8863 -0.2237 0.0125 -0.5939 -0.3406]
count =   28, y = 8.4471e-01, ymin = 1.7279e-06, x = [-0.1804 1.8237 0.2108 0.1880 -0.5358 0.3260]
count =   29, y = 2.9871e-01, ymin = 1.7279e-06, x = [-0.1449 1.2762 0.1205 0.6442 -0.9905 -0.2114]
count =   30, y = 3.6053e-01, ymin = 1.7279e-06, x = [-0.2651 1.5994 0.1529 0.2038 -1.0580 -0.1560]
count =   31, y = 6.3999e-03, ymin = 1.7279e-06, x = [0.0543 1.7391 -0.0647 0.3744 -0.7281 0.7396]
count =   32, y = 8.4532e-01, ymin = 1.7279e-06, x = [-0.3481 1.9474 -0.1548 0.3124 -1.1343 0.4860]
count =   33, y = 2.8738e-01, ymin = 1.7279e-06, x = [-0.2743 1.5171 -0.3177 0.0027 -0.6799 0.5547]
count =   34, y = 9.3253e-03, ymin = 1.7279e-06, x = [-0.3365 1.8426 -0.2217 0.8462 -0.9883 0.2685]
count =   35, y = 8.7040e-01, ymin = 1.7279e-06, x = [0.0158 1.6199 -0.3552 1.0551 -1.0680 0.3061]
count =   36, y = 4.9339e-02, ymin = 1.7279e-06, x = [-0.4302 1.4775 0.1500 1.1715 -0.7176 0.1157]
count =   37, y = 1.0862e-01, ymin = 1.7279e-06, x = [0.0115 1.8020 0.0814 0.9768 -0.6557 0.5654]


#################### GeneralizedSpinLossFunction ####################
Loss Function Info:
stdout = <_io.TextIOWrapper name='./log/hub-u-8.0000-nelec-6.log' mode='w' encoding='UTF-8'>
h1e = [[ 0. -1.  0.  0.  0. -1.]
 [-1.  0. -1.  0.  0.  0.]
 [ 0. -1.  0. -1.  0.  0.]
 [ 0.  0. -1.  0. -1.  0.]
 [ 0.  0.  0. -1.  0. -1.]
 [-1.  0.  0.  0. -1.  0.]]
rdm1_tag = [[ 1.00000000e+00  3.27136735e-01 -3.15549381e-17 -6.22326908e-02
  -1.38587046e-16  3.27136735e-01]
 [ 3.27136735e-01  1.00000000e+00  3.27136735e-01  4.33923795e-17
  -6.22326908e-02  1.71462084e-16]
 [-3.15549381e-17  3.27136735e-01  1.00000000e+00  3.27136735e-01
  -4.28437139e-17 -6.22326908e-02]
 [-6.22326908e-02  4.33923795e-17  3.27136735e-01  1.00000000e+00
   3.27136735e-01  2.82264070e-17]
 [-1.38587046e-16 -6.22326908e-02 -4.28437139e-17  3.27136735e-01
   1.00000000e+00  3.27136735e-01]
 [ 3.27136735e-01  1.71462084e-16 -6.22326908e-02  2.82264070e-17
   3.27136735e-01  1.00000000e+00]]
fit_inds = [[0 1]
 [2 3]
 [4 5]]
nelecs = (3, 3)
loss_func_type = 2
ind_triu = (Array([0, 0, 1], dtype=int32), Array([0, 1, 1], dtype=int32))
num_triu = 3
num_parm = 12
nfrag = 3
nimp = 2
nsite = 6
h1es = [[[ 0. -1.  0.  0.  0. -1.]
  [-1.  0. -1.  0.  0.  0.]
  [ 0. -1.  0. -1.  0.  0.]
  [ 0.  0. -1.  0. -1.  0.]
  [ 0.  0.  0. -1.  0. -1.]
  [-1.  0.  0.  0. -1.  0.]]

 [[ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]]

 [[ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]
  [ 0.  0.  0.  0.  0.  0.]]

 [[ 0. -1.  0.  0.  0. -1.]
  [-1.  0. -1.  0.  0.  0.]
  [ 0. -1.  0. -1.  0.  0.]
  [ 0.  0. -1.  0. -1.  0.]
  [ 0.  0.  0. -1.  0. -1.]
  [-1.  0.  0.  0. -1.  0.]]]
_get_v1es = <function LossFunctionMixin._gen_get_v1es.<locals>.get_v1es at 0x120af27a0>
_get_rdm1 = <function GeneralizedSpinLossFunction._gen_get_rdm1.<locals>.get_rdm1 at 0x120af2520>
func = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x120af2b60>
grad = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x120af2660>
hess = <function LossFunctionMixin.__init__.<locals>.<lambda> at 0x120af1ee0>
#####################################################################


####################
GeneralizedSpinLossFunction
nimp = 2, nsite = 6
nelecs = (3, 3)
loss_func_type = 2
count =    0, y = 1.4405e+00, ymin = 1.4405e+00, x = [0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000 0.0000]
count =    1, y = 1.4184e+00, ymin = 1.4184e+00, x = [0.3191 0.2643 0.0066 0.5324 0.2771 0.4848 -0.2882 -0.4230 -0.3131 0.3261 -0.4137 0.4782]
count =    2, y = 1.1562e-02, ymin = 1.1562e-02, x = [-0.0085 0.8542 0.1520 0.7293 0.8588 -0.0645 -0.5099 0.1376 -0.5417 0.8176 0.1618 0.7215]
count =    3, y = 1.4103e-02, ymin = 1.1562e-02, x = [0.1916 1.3173 0.2121 0.6960 0.7291 -0.5705 -0.3758 0.1363 -0.5039 0.6542 -0.4102 0.8368]
count =    4, y = 7.3874e-06, ymin = 7.3874e-06, x = [-0.1183 1.5393 -0.0607 0.8686 0.1527 -0.9161 -0.3287 -0.4355 -0.5627 1.0297 -0.7721 0.6980]
count =    5, y = 2.6918e-01, ymin = 7.3874e-06, x = [-0.1062 1.4227 -0.4975 0.3153 -0.1257 -0.6066 -0.6623 -0.5919 -1.0232 -0.0359 -0.9780 1.2473]
count =    6, y = 5.3653e-01, ymin = 7.3874e-06, x = [0.1534 1.4600 0.4807 0.7673 -0.3813 -0.5431 -0.3882 -0.2337 -0.5545 0.7893 -1.1142 0.8903]
count =    7, y = 1.1135e-01, ymin = 7.3874e-06, x = [-0.6221 1.0773 -0.0745 1.2492 0.2428 -1.0909 -0.9078 -0.1786 -0.6923 0.9622 -0.2582 0.3750]
count =    8, y = 2.9088e-03, ymin = 7.3874e-06, x = [-0.1322 1.3450 0.2287 0.5551 -0.0948 -0.3478 0.2665 -0.1936 -1.0152 0.9825 -0.6037 0.2138]
count =    9, y = 3.5024e-06, ymin = 3.5024e-06, x = [-0.5113 1.1059 0.2132 0.5664 0.2669 -0.9919 -0.1559 -0.5022 -0.9491 1.2954 -0.5047 -0.1012]
count =   10, y = 1.0267e+00, ymin = 3.5024e-06, x = [-0.0730 0.5665 0.3748 0.3418 0.4016 -0.5106 -0.3183 -0.1614 -0.5647 1.2708 -0.9342 0.2203]
count =   11, y = 2.2266e-06, ymin = 2.2266e-06, x = [-0.8361 1.1815 -0.1575 0.8870 0.6176 -1.2941 -0.7634 -0.5427 -0.5878 1.3226 -0.5967 0.0333]
count =   12, y = 2.9305e-01, ymin = 2.2266e-06, x = [-0.5142 1.5081 0.2991 0.4018 0.1202 -1.8378 -0.1583 -0.1658 -0.8011 1.3916 -0.9557 -0.6158]
count =   13, y = 1.0227e+00, ymin = 2.2266e-06, x = [-0.3476 0.6052 -0.3899 0.9805 0.2524 -1.9349 -0.3827 -0.3622 0.0040 1.2225 -1.0503 -0.3774]
count =   14, y = 5.6863e-06, ymin = 2.2266e-06, x = [-1.5486 0.9072 -0.6803 0.7930 0.1952 -0.9472 -0.5691 0.0745 -0.6397 1.7324 -0.3613 0.3569]
count =   15, y = 1.5601e-03, ymin = 2.2266e-06, x = [-1.6074 0.6477 -0.3274 1.3907 0.6621 -1.6334 -1.0782 -0.3747 -0.2632 1.8922 -0.1302 0.2665]
count =   16, y = 1.0721e-06, ymin = 1.0721e-06, x = [-2.0817 0.3887 -0.7352 1.1061 0.9412 -1.4170 -0.9848 -0.4137 -0.8392 1.9055 -0.3003 0.6338]
count =   17, y = 3.6269e-01, ymin = 1.0721e-06, x = [-1.6761 0.2907 -1.3014 1.7655 1.0541 -1.7253 -1.2796 -0.4521 -1.4318 2.1212 -0.0183 0.6446]
count =   18, y = 2.0666e-06, ymin = 1.0721e-06, x = [-2.4666 0.5540 -0.7380 1.7517 1.2440 -1.8389 -0.7760 -0.2243 -1.3807 1.6614 -0.6493 0.4991]
count =   19, y = 1.8061e-02, ymin = 1.0721e-06, x = [-2.8147 0.1047 -0.3952 1.7641 0.6982 -1.3192 -1.1067 0.4590 -1.5820 1.7468 -0.3007 0.6837]
count =   20, y = 5.5640e-01, ymin = 1.0721e-06, x = [-2.2832 -0.5383 -0.8088 1.1541 0.9858 -1.3806 -1.3620 -0.0947 -1.6392 1.6392 -0.5478 0.6794]
count =   21, y = 4.2726e-01, ymin = 1.0721e-06, x = [-3.3458 0.3933 -0.0388 1.8433 0.5815 -1.2145 -0.5252 0.4373 -2.2406 1.1570 -0.1480 1.2552]
count =   22, y = 2.4593e-02, ymin = 1.0721e-06, x = [-2.8425 -0.3049 -0.0362 2.2631 0.3111 -1.8797 -1.7777 0.9309 -1.2586 1.4121 0.0732 0.4518]
count =   23, y = 2.3424e-01, ymin = 1.0721e-06, x = [-3.3688 -0.0220 -1.0863 2.0009 1.0780 -0.7199 -0.6041 0.5726 -1.6907 1.9495 -0.4974 0.7988]
count =   24, y = 2.2444e-01, ymin = 1.0721e-06, x = [-2.0852 -0.3205 -1.0702 1.7850 0.1907 -1.8611 -1.1043 0.5627 -1.4576 1.4989 0.2331 1.2085]
count =   25, y = 1.0561e+00, ymin = 1.0721e-06, x = [-3.3107 -0.6002 0.3370 1.4968 0.1697 -1.8895 -1.4129 0.2000 -1.0073 1.7552 -0.8648 1.2167]
count =   26, y = 1.7717e-01, ymin = 1.0721e-06, x = [-3.1401 -0.5390 -0.1443 1.6157 1.1494 -1.9720 -1.4134 0.4365 -2.1982 1.6424 -0.0841 0.5373]
count =   27, y = 1.5528e-01, ymin = 1.0721e-06, x = [-3.2828 0.2399 -0.1135 1.7980 0.6391 -1.0416 -1.3504 -0.1792 -1.0317 2.3487 0.0101 0.1044]
